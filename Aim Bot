local player = game.Players.LocalPlayer
local uis = game:GetService("UserInputService")
local runService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local locking = false
local target = nil
local FOV = 60
local smoothness = 0.4

local fovCircle = Drawing.new("Circle")
fovCircle.Visible = true
fovCircle.Thickness = 2
fovCircle.Color = Color3.fromRGB(255, 255, 255)
fovCircle.Radius = FOV
fovCircle.Filled = false
fovCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)

local function canSeePartially(head)
    local camCF = camera:GetRenderCFrame()
    local rayOrigin = camCF.Position

    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {player.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

    local offsets = {
        Vector3.new(0, 0, 0),
        Vector3.new(0.3, 0, 0),
        Vector3.new(-0.3, 0, 0),
        Vector3.new(0, 0.3, 0),
        Vector3.new(0, -0.3, 0)
    }

    local visibleCount = 0

    for _, off in ipairs(offsets) do
        local targetPos = head.Position + off
        local dir = targetPos - rayOrigin

        local result = workspace:Raycast(rayOrigin, dir, raycastParams)
        if not result or result.Instance:IsDescendantOf(head.Parent) then
            visibleCount += 1
        end
    end

    return visibleCount > 0, visibleCount >= #offsets
end

local function getClosestPlayerInFOV()
    local closest = nil
    local closestDist = FOV
    local center = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)

    for _, p in ipairs(game.Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("Head") then
            local head = p.Character.Head
            local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)

            if onScreen then
                local dist = (center - Vector2.new(screenPos.X, screenPos.Y)).Magnitude

                if dist < closestDist then
                    local canSee, fullVisible = canSeePartially(head)

                    if canSee then
                        closest = {head = head, full = fullVisible}
                        closestDist = dist
                    end
                end
            end
        end
    end

    return closest
end

uis.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.T then
        locking = true
    end
end)

uis.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.T then
        locking = false
        target = nil
    end
end)

runService.RenderStepped:Connect(function()
    fovCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    fovCircle.Radius = FOV

    if locking then
        local found = getClosestPlayerInFOV()

        if found and found.head then
            target = found
            local aimPoint = found.head.Position

            if found.full then
                aimPoint = aimPoint + Vector3.new(0, 0.1, 0)
            end

            local camCF = camera:GetRenderCFrame()
            local newCF = CFrame.new(camCF.Position, aimPoint)

            camera.CFrame = camCF:Lerp(newCF, smoothness)
        end
    end
end)
