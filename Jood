local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local Window = Fluent:CreateWindow({
    Title = "Jood Piece",
    SubTitle = "by LuckyZ",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = false, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Auto Farm", Icon = "box" }),
    Skills = Window:AddTab({ Title = "Skills", Icon = "swords" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" }) -- เพิ่ม Tab Setting
}

local Settings = {
    Enabled = false,
    AutoSkill = false,
    Monsters = {},
    Tool = nil,
    Position = "Above",
    Distance = 11,
    Skills = { Z = false, X = false, C = false, V = false, B = false }
}

local CurrentTarget = nil

local function getHRP()
    local char = player.Character
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function equipTool()
    if Settings.Tool and player.Character then
        if not player.Character:FindFirstChild(Settings.Tool) then
            local tool = player.Backpack:FindFirstChild(Settings.Tool)
            if tool then 
                tool.Parent = player.Character 
            end
        end
    end
end

local function getFarmCFrame(mobHRP)
    local d = Settings.Distance
    if Settings.Position == "Behind" then
        return mobHRP.CFrame * CFrame.new(0, 0, d)
    elseif Settings.Position == "Above" then
        return mobHRP.CFrame * CFrame.new(0, d, 0)
    elseif Settings.Position == "Below" then
        return mobHRP.CFrame * CFrame.new(0, -d, 0)
    end
    return mobHRP.CFrame
end

local function findTarget()
    if CurrentTarget and CurrentTarget.Parent and CurrentTarget:FindFirstChild("HumanoidRootPart") then
        local hum = CurrentTarget:FindFirstChildOfClass("Humanoid")
        if hum and hum.Health > 0 then
            return CurrentTarget, CurrentTarget.HumanoidRootPart
        end
    end

    local root = workspace:FindFirstChild("Mobs")
    if not root then return nil end

    local closestMob = nil
    local shortestDist = math.huge
    local myHRP = getHRP()
    if not myHRP then return nil end

    for _, mob in ipairs(root:GetDescendants()) do
        if mob:IsA("Model") and mob:FindFirstChild("HumanoidRootPart") then
            if Settings.Monsters[mob.Name] then
                local hum = mob:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health > 0 then
                    local dist = (myHRP.Position - mob.HumanoidRootPart.Position).Magnitude
                    if dist < shortestDist then
                        shortestDist = dist
                        closestMob = mob
                    end
                end
            end
        end
    end

    CurrentTarget = closestMob
    return closestMob, (closestMob and closestMob.HumanoidRootPart)
end

local MonsterDrop = Tabs.Main:AddDropdown("MonsterDrop", {
    Title = "Select Monsters",
    Values = {"None"},
    Multi = true,
    Default = {},
    Callback = function(v) 
        Settings.Monsters = v 
        CurrentTarget = nil 
    end
})

local ToolDrop = Tabs.Main:AddDropdown("ToolDrop", {
    Title = "Select Tool",
    Values = {"None"},
    Callback = function(v) Settings.Tool = v end
})

local function RefreshList()
    -- Monsters
    local mobs, seen = {}, {}
    local root = workspace:FindFirstChild("Mobs")
    if root then
        for _, m in ipairs(root:GetDescendants()) do
            if m:IsA("Model") and m:FindFirstChild("HumanoidRootPart") and not seen[m.Name] then
                seen[m.Name] = true
                table.insert(mobs, m.Name)
            end
        end
    end
    MonsterDrop:SetValues(mobs)

    -- Tools (Check Backpack & Character)
    local tools = {}
    local function checkTools(container)
        for _, t in ipairs(container:GetChildren()) do
            if t:IsA("Tool") and not table.find(tools, t.Name) then
                table.insert(tools, t.Name)
            end
        end
    end
    checkTools(player.Backpack)
    if player.Character then checkTools(player.Character) end
    ToolDrop:SetValues(tools)
end

Tabs.Main:AddButton({
    Title = "Refresh List",
    Callback = RefreshList
})

Tabs.Main:AddDropdown("PosDrop", {
    Title = "Farm Position",
    Values = {"Behind","Above","Below"},
    Default = "Above",
    Callback = function(v) Settings.Position = v end
})

Tabs.Main:AddSlider("Dist", {
    Title = "Distance",
    Min = 1, Max = 25, Default = 11, Rounding = 1,
    Callback = function(v) Settings.Distance = v end
})

Tabs.Main:AddToggle("Farm", {
    Title = "Auto Farm",
    Default = false,
    Callback = function(v) Settings.Enabled = v end
})

Tabs.Main:AddToggle("AutoSkill", {
    Title = "Auto Skill",
    Default = false,
    Callback = function(v) Settings.AutoSkill = v end
})

for _, k in ipairs({"Z", "X", "C", "V", "B"}) do
    Tabs.Skills:AddToggle("Skill"..k, {
        Title = "Skill ["..k.."]",
        Default = false,
        Callback = function(v) Settings.Skills[k] = v end
    })
end

-- Settings Tab Content
Tabs.Settings:AddToggle("Disable3D", {
    Title = "Disable 3D Rendering",
    Description = "ช่วยลดความร้อนของเครื่องขณะฟาร์ม",
    Default = false,
    Callback = function(v)
        RunService:Set3dRenderingEnabled(not v)
    end
})

task.spawn(function()
    while true do
        RunService.Heartbeat:Wait()
        if not Settings.Enabled then continue end

        pcall(function()
            local myHRP = getHRP()
            if not myHRP then return end

            local mobModel, mobHRP = findTarget()

            if mobModel and mobHRP then
                equipTool()
                myHRP.CFrame = CFrame.lookAt(getFarmCFrame(mobHRP).Position, mobHRP.Position)
                myHRP.Velocity = Vector3.new(0,0,0)

                VirtualUser:CaptureController()
                VirtualUser:ClickButton1(Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2))
            end
        end)
    end
end)

task.spawn(function()
    while true do
        task.wait(0.5)
        if Settings.Enabled or Settings.AutoSkill then
            pcall(function()
                if not CurrentTarget then
                    findTarget()
                end
                if player.Character and CurrentTarget then
                    equipTool()
                    for key, isEnabled in pairs(Settings.Skills) do
                        if isEnabled then
                            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode[key], false, game)
                            task.wait(0.05) -- กดค้างไว้แป๊บหนึ่งเพื่อให้เกมรับรู้
                            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode[key], false, game)
                        end
                    end
                end
            end)
        end
    end
end)

player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)

RefreshList()
Window:SelectTab(1)
