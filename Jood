local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local dataRemote = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local Window = Fluent:CreateWindow({
    Title = "Jood Piece [2.0]",
    SubTitle = "by LuckyZ",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = false,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Auto Farm", Icon = "box" }),
    Auto = Window:AddTab({ Title = "Auto", Icon = "refresh-cw" }),
    Skills = Window:AddTab({ Title = "Skills", Icon = "swords" }),
    Teleport = Window:AddTab({ Title = "Teleport", Icon = "map-pin" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Settings = {
    Enabled = false,
    AutoSkill = false,
	AutoSukunaw = false,
	AutoFlashy = false,
    AutoSummon = false,
    Monsters = {},
    Tool = nil,
    Position = "Above",
    Distance = 11,
    Skills = { Z = false, X = false, C = false, V = false, B = false },
    SelectedCraftItem = "Heavenly Arrow",
    SelectedStoreItem = {},
}

local IslandLocations = {
    ["Starter Island"] = CFrame.new(-45.4874115, 21.7141285, 181.472717),
    ["Beast Island"] = CFrame.new(-333.850067, 11.9821749, -2448.74438),
    ["Cave Island"] = CFrame.new(1540.15881, 10.9430971, 929.851685),
    ["Event Island"] = CFrame.new(-1158.34314, 16.0606022, -1480.6676),
    ["Jojo Island"] = CFrame.new(1816.94287109375, 13.832566261291504, -150.20919799804688),
    ["DIO Island"] = CFrame.new(-2496.0341796875, 10.730810165405273, 535.1491088867188),
	["Boss Island"] = CFrame.new(-2750.375732421875, 19.725997924804688, -1403.254638671875),
    ["Orb Island"] = CFrame.new(-2265.076904296875, 10.042778968811035, 1622.0653076171875),
}

local CurrentTarget = nil

local function getMonsterRoots()
    local roots = {}
    if workspace:FindFirstChild("Mobs") then
        table.insert(roots, workspace.Mobs)
    end
    return roots
end

local function getHRP()
    local char = player.Character
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function equipTool()
    if Settings.Tool and player.Character then
        if not player.Character:FindFirstChild(Settings.Tool) then
            local tool = player.Backpack:FindFirstChild(Settings.Tool)
            if tool then
                tool.Parent = player.Character
            end
        end
    end
end

local function AttackRemote(skillName)
    local myHRP = getHRP()
    if not myHRP then return end
    local args = { { { "Skill", skillName, myHRP.CFrame }, "\004" } }
    dataRemote:FireServer(unpack(args))
end

local function getFarmCFrame(mobHRP)
    local d = Settings.Distance
    if Settings.Position == "Behind" then
        return mobHRP.CFrame * CFrame.new(0, 0, d)
    elseif Settings.Position == "Above" then
        return mobHRP.CFrame * CFrame.new(0, d, 0)
    elseif Settings.Position == "Below" then
        return mobHRP.CFrame * CFrame.new(0, -d, 0)
    end
    return mobHRP.CFrame
end

local function findTarget()
    if CurrentTarget and CurrentTarget.Parent and CurrentTarget:FindFirstChild("HumanoidRootPart") then
        local hum = CurrentTarget:FindFirstChildOfClass("Humanoid")
        if hum and hum.Health > 0 then
            return CurrentTarget, CurrentTarget.HumanoidRootPart
        end
    end
    local roots = getMonsterRoots()
    local closestMob = nil
    local shortestDist = math.huge
    local myHRP = getHRP()
    if not myHRP then return nil end
    for _, root in ipairs(roots) do
        for _, mob in ipairs(root:GetDescendants()) do
            if mob:IsA("Model") and mob:FindFirstChild("HumanoidRootPart") then
                if Settings.Monsters[mob.Name] then
                    local hum = mob:FindFirstChildOfClass("Humanoid")
                    if hum and hum.Health > 0 then
                        local dist = (myHRP.Position - mob.HumanoidRootPart.Position).Magnitude
                        if dist < shortestDist then
                            shortestDist = dist
                            closestMob = mob
                        end
                    end
                end
            end
        end
    end
    CurrentTarget = closestMob
    return closestMob, (closestMob and closestMob.HumanoidRootPart)
end

local function bringMonsters(targetHRP)
    if not Settings.BringMob or not targetHRP then return end
    local roots = getMonsterRoots()
    for _, root in ipairs(roots) do
        for _, mob in ipairs(root:GetDescendants()) do
            if mob:IsA("Model") and mob:FindFirstChild("HumanoidRootPart") and mob.Name == targetHRP.Parent.Name then
                if mob ~= targetHRP.Parent then
                    local hum = mob:FindFirstChildOfClass("Humanoid")
                    if hum and hum.Health > 0 then
                        mob.HumanoidRootPart.CFrame = targetHRP.CFrame
                        mob.HumanoidRootPart.CanCollide = false
                    end
                end
            end
        end
    end
end

local function AutoFarmSkillLoop()
    while Settings.Enabled do
        task.wait(0.3)
        if CurrentTarget and player.Character then
            pcall(function()
                for key, isEnabled in pairs(Settings.Skills) do
                    if isEnabled and Settings.Enabled then
                        AttackRemote(key)
                    end
                end
            end)
        end
    end
end

local function AutoFarmLoop()
    task.spawn(AutoFarmSkillLoop)
    while Settings.Enabled do
        RunService.Heartbeat:Wait()
        pcall(function()
            local myHRP = getHRP()
            local mobModel, mobHRP = findTarget()
            if mobModel and mobHRP then
                equipTool()
                if Settings.BringMob then
                    bringMonsters(mobHRP)
                end
                local targetCFrame = getFarmCFrame(mobHRP)
                myHRP.CFrame = CFrame.lookAt(targetCFrame.Position, mobHRP.Position)
                myHRP.Velocity = Vector3.new(0,0,0)
                AttackRemote("A")
            end
        end)
    end
end

local function StandAutoSkillLoop()
    while Settings.AutoSkill do
        task.wait(0.5)
        if not Settings.Enabled then
            pcall(function()
                equipTool()
                for key, isEnabled in pairs(Settings.Skills) do
                    if isEnabled then
                        AttackRemote(key)
                    end
                end
            end)
        end
    end
end

local function AutoStoreLoop()
    if Settings.AutoStore then
        pcall(function()
            for _, tool in pairs(player.Backpack:GetChildren()) do
                if tool:IsA("Tool") and Settings.SelectedStoreItem[tool.Name] then
                    ReplicatedStorage.System.Inv.Inventory:InvokeServer("Add", tool.Name)
                    task.wait(0.1)
                end
            end
        end)
    end

    local connection
    connection = player.Backpack.ChildAdded:Connect(function(tool)
        if not Settings.AutoStore then
            if connection then connection:Disconnect() end
            return
        end

        if tool:IsA("Tool") and Settings.SelectedStoreItem[tool.Name] then
            task.wait(0.1)
            ReplicatedStorage.System.Inv.Inventory:InvokeServer("Add", tool.Name)
        end
    end)
end

local function AutoCraftLoop()
    while Settings.AutoCraft do
        task.wait(0.25)
        pcall(function()
            ReplicatedStorage.System.CraftItem:FireServer(Settings.SelectedCraftItem)
        end)
    end
end

local function AutoSummonSukunaLoop()
    while Settings.AutoSukuna do
        task.wait(1.5)
        pcall(function()
            local bossIsland = workspace:FindFirstChild("Mobs") and workspace.Mobs:FindFirstChild("Boss Island")
            local SukunaExist = bossIsland and bossIsland:FindFirstChild("Sukuna")

            if not SukunaExist then
                local playerGui = player:FindFirstChild("PlayerGui")
                local summonMenu = playerGui and playerGui:FindFirstChild("MainGui") and playerGui.MainGui:FindFirstChild("SUMMON")
                
                if summonMenu then
                    if summonMenu.Visible == false then 
                        summonMenu.Visible = true
                    end

                    local summonBtn = summonMenu.Main:FindFirstChild("Sukuna")

                    if summonBtn and summonBtn.Visible then
                        local pos = summonBtn.AbsolutePosition
                        local size = summonBtn.AbsoluteSize
                        local centerX = pos.X + (size.X / 2)
                        local centerY = pos.Y + (size.Y / 2) + 58

                        VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
                        task.wait(0.1)
                        VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)
                    end
                end
            end
        end)
    end
end

local function AutoSummonFlashyLoop()
    while Settings.AutoFlashy do
        task.wait(1.5)
        pcall(function()
            local bossIsland = workspace:FindFirstChild("Mobs") and workspace.Mobs:FindFirstChild("Boss Island")
            local flashyExist = bossIsland and bossIsland:FindFirstChild("Flashy Flash")

            if not flashyExist then
                local playerGui = player:FindFirstChild("PlayerGui")
                local summonMenu = playerGui and playerGui:FindFirstChild("MainGui") and playerGui.MainGui:FindFirstChild("SUMMON")
                
                if summonMenu then
                    if summonMenu.Visible == false then 
                        summonMenu.Visible = true
                    end

                    local summonBtn = summonMenu.Main:FindFirstChild("Flashy Flash")

                    if summonBtn and summonBtn.Visible then
                        local pos = summonBtn.AbsolutePosition
                        local size = summonBtn.AbsoluteSize
                        local centerX = pos.X + (size.X / 2)
                        local centerY = pos.Y + (size.Y / 2) + 58

                        VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
                        task.wait(0.1)
                        VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)
                    end
                end
            end
        end)
    end
end

local function DioClickAction()
    local dioNPC = workspace.NPC:FindFirstChild("DioNPC")
    if dioNPC then
        local myHRP = getHRP()
        local char = player.Character
        if myHRP and char then
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:UnequipTools()
            end
            local npcPos = dioNPC:GetPivot().Position
            myHRP.CFrame = dioNPC:GetPivot() * CFrame.new(0, 0, 1.8)
            myHRP.CFrame = CFrame.lookAt(myHRP.Position, Vector3.new(npcPos.X, myHRP.Position.Y, npcPos.Z))
            workspace.CurrentCamera.CFrame = CFrame.lookAt(workspace.CurrentCamera.CFrame.Position, npcPos)
            task.wait(0.2)
            local viewportSize = workspace.CurrentCamera.ViewportSize
            local centerX, centerY = viewportSize.X / 2, viewportSize.Y / 2
            VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
            task.wait(0.05)
            VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)
        end
    end
end

local function AutoSummonLoop()
    while Settings.AutoSummon do
        task.wait(1.5)
        pcall(function()
            local dioExist = false
            local mobs = workspace:FindFirstChild("Mobs")
            if mobs and mobs:FindFirstChild("DIO Island") and mobs["DIO Island"]:FindFirstChild("DIO Overheaven") then
                dioExist = true
            end
            if not dioExist then
                local hasArrow = player.Backpack:FindFirstChild("Heavenly Arrow") or player.Character:FindFirstChild("Heavenly Arrow")
                if not hasArrow then
                    ReplicatedStorage.System.Inv.Inventory:InvokeServer("Remove", "Heavenly Arrow")
                    task.wait(0.8)
                end
                DioClickAction()
            end
        end)
    end
end

local MonsterDrop = Tabs.Main:AddDropdown("MonsterDrop", {
    Title = "Select Monsters",
    Values = {"None"},
    Multi = true,
    Default = {},
    Callback = function(v)
        Settings.Monsters = v
        CurrentTarget = nil
    end
})

local ToolDrop = Tabs.Main:AddDropdown("ToolDrop", {
    Title = "Select Tool",
    Values = {"None"},
    Callback = function(v)
        Settings.Tool = v
    end
})

local function RefreshList()
    local mobs, seen = {}, {}
    local roots = getMonsterRoots()
    for _, root in ipairs(roots) do
        for _, m in ipairs(root:GetDescendants()) do
            if m:IsA("Model") and m:FindFirstChild("HumanoidRootPart") and not seen[m.Name] then
                seen[m.Name] = true
                table.insert(mobs, m.Name)
            end
        end
    end
    MonsterDrop:SetValues(mobs)
    local tools = {}
    local function checkTools(container)
        for _, t in ipairs(container:GetChildren()) do
            if t:IsA("Tool") and not table.find(tools, t.Name) then
                table.insert(tools, t.Name)
            end
        end
    end
    checkTools(player.Backpack)
    if player.Character then checkTools(player.Character) end
    ToolDrop:SetValues(tools)
end

Tabs.Main:AddButton({
    Title = "Refresh List",
    Callback = function()
        RefreshList()
    end
})

Tabs.Main:AddDropdown("PosDrop", {
    Title = "Farm Position",
    Values = {"Behind","Above","Below"},
    Default = "Above",
    Callback = function(v)
        Settings.Position = v
    end
})

Tabs.Main:AddSlider("Dist", {
    Title = "Distance",
    Min = 1,
    Max = 25,
    Default = 11,
    Rounding = 1,
    Callback = function(v)
        Settings.Distance = v
    end
})

Tabs.Main:AddToggle("Farm", {
    Title = "Auto Farm",
    Default = false,
    Callback = function(v)
        Settings.Enabled = v
        if v then 
            task.spawn(AutoFarmLoop) 
        end
    end
})

Tabs.Main:AddToggle("BringMob", {
    Title = "Bring Mobs",
    Default = false,
    Callback = function(v)
        Settings.BringMob = v
    end
})

Tabs.Main:AddToggle("AutoSkill", {
    Title = "Auto Skill",
    Default = false,
    Callback = function(v)
        Settings.AutoSkill = v
        if v then 
            task.spawn(StandAutoSkillLoop) 
        end
    end
})

Tabs.Main:AddToggle("Auto Sukuna", {
    Title = "Auto Summon Sukuna",
    Default = false,
    Callback = function(v)
        Settings.AutoSukuna = v
        if v then
            task.spawn(AutoSummonSukunaLoop)
        end
    end
})

Tabs.Main:AddToggle("Auto Flashy", {
    Title = "Auto Summon Flashy Flash",
    Default = false,
    Callback = function(v)
        Settings.AutoFlashy = v
        if v then
            task.spawn(AutoSummonFlashyLoop)
        end
    end
})

Tabs.Main:AddToggle("AutoSummon", {
    Title = "Auto Summon DIO",
    Default = false,
    Callback = function(v)
        Settings.AutoSummon = v
        if v then 
            task.spawn(AutoSummonLoop) 
        end
    end
})

local StoreDrop = Tabs.Auto:AddDropdown("StoreDrop", {
    Title = "Select Items to Store",
    Values = {"None"},
    Multi = true,
    Default = {},
    Callback = function(v)
        Settings.SelectedStoreItem = v
    end
})

Tabs.Auto:AddButton({
    Title = "Refresh Inventory",
    Callback = function()
        local items = {}
        local function scan(c)
            for _, t in ipairs(c:GetChildren()) do
                if t:IsA("Tool") and not table.find(items, t.Name) then
                    table.insert(items, t.Name)
                end
            end
        end
        scan(player.Backpack)
        if player.Character then scan(player.Character) end
        StoreDrop:SetValues(items)
    end
})

Tabs.Auto:AddToggle("AutoStore", {
    Title = "Auto Store",
    Default = false,
    Callback = function(v)
        Settings.AutoStore = v
        if v then 
            task.spawn(AutoStoreLoop) 
        end
    end
})

Tabs.Auto:AddDropdown("CraftSelect", {
    Title = "Select Item",
    Values = { "Heavenly Arrow", "Cid Cloak", "Take Copter"},
    Default = "Heavenly Arrow",
    Callback = function(v)
        Settings.SelectedCraftItem = v
    end
})

Tabs.Auto:AddToggle("AutoCraft", {
    Title = "Auto Craft",
    Default = false,
    Callback = function(v)
        Settings.AutoCraft = v
        if v then 
            task.spawn(AutoCraftLoop) 
        end
    end
})

Tabs.Auto:AddButton({
    Title = "Manual Craft",
    Callback = function()
        ReplicatedStorage.System.CraftItem:FireServer(Settings.SelectedCraftItem)
    end
})

Tabs.Auto:AddButton({
    Title = "Random Crate",
    Callback = function()
        ReplicatedStorage.System.RandomItem:FireServer(5)
    end
})

-- Tabs: Skills
for _, k in ipairs({"Z", "X", "C", "V", "B"}) do
    Tabs.Skills:AddToggle("Skill"..k, {
        Title = "Skill ["..k.."]",
        Default = false,
        Callback = function(v)
            Settings.Skills[k] = v
        end
    })
end

local IslandList = {}
for name, _ in pairs(IslandLocations) do
    table.insert(IslandList, name)
end
table.sort(IslandList)

Tabs.Teleport:AddDropdown("IslandDrop", {
    Title = "Select Island",
    Values = IslandList,
    Callback = function(v)
        local pos = IslandLocations[v]
        local hrp = getHRP()
        if hrp and pos then
            hrp.CFrame = pos
        end
    end
})

Tabs.Settings:AddToggle("Disable3D", {
    Title = "Disable 3D Rendering",
    Default = false,
    Callback = function(v)
        RunService:Set3dRenderingEnabled(not v)
    end
})

local FpsValue = 60
Tabs.Settings:AddInput("FpsInput", {
    Title = "FPS Lock",
    Default = "60",
    Numeric = true,
    Finished = false,
    Callback = function(v)
        FpsValue = tonumber(v) or 60
    end
})

Tabs.Settings:AddButton({
    Title = "Apply",
    Callback = function()
        if setfpscap then
            setfpscap(FpsValue)
        end
    end
})

Tabs.Settings:AddToggle("AFK", {
    Title = "AFK Mode",
    Default = false,
    Callback = function(v)
        if v then
            RunService:Set3dRenderingEnabled(false)
            if setfpscap then
                setfpscap(20)
            end
        else
            RunService:Set3dRenderingEnabled(true)
            if setfpscap then
                setfpscap(180)
            end
        end
    end
})

player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new(0,0))
end)

RefreshList()
Window:SelectTab(1)
