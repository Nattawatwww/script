local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Vim = game:GetService("VirtualInputManager")

local lp = Players.LocalPlayer
local Balls = workspace:WaitForChild("Balls")

-- üî• ‡∏à‡∏π‡∏ô‡πÇ‡∏´‡∏î
local BASE_DISTANCE = 35
local MAX_DISTANCE = 70
local BASE_PREDICT = 0.015

if _G.ParryConnection then
    _G.ParryConnection:Disconnect()
end

-- ‡∏Å‡∏î F ‡πÇ‡∏´‡∏î (double tap ‡πÄ‡∏ü‡∏£‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
local function parry()
    Vim:SendKeyEvent(true, Enum.KeyCode.F, false, game)
    Vim:SendKeyEvent(false, Enum.KeyCode.F, false, game)
    Vim:SendKeyEvent(true, Enum.KeyCode.F, false, game)
    Vim:SendKeyEvent(false, Enum.KeyCode.F, false, game)
end

-- predict ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
local function predict(ball)
    local speed = ball.AssemblyLinearVelocity.Magnitude
    local predictTime = math.clamp(BASE_PREDICT + speed * 0.00015, 0.015, 0.06)
    return ball.Position + ball.AssemblyLinearVelocity * predictTime
end

-- ‡∏£‡∏∞‡∏¢‡∏∞ parry ‡∏ï‡∏≤‡∏°‡∏™‡∏õ‡∏µ‡∏î (360)
local function getDistance(ball)
    local speed = ball.AssemblyLinearVelocity.Magnitude
    return math.clamp(BASE_DISTANCE + speed * 0.08, BASE_DISTANCE, MAX_DISTANCE)
end

-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏°‡∏∏‡∏°)
local function getThreatBall(hrp)
    local best
    local bestScore = math.huge

    for _, b in ipairs(Balls:GetChildren()) do
        local part = b:IsA("BasePart") and b or b:FindFirstChildWhichIsA("BasePart")
        if part then
            local pos = predict(part)
            local dist = (pos - hrp.Position).Magnitude
            local maxDist = getDistance(part)

            if dist <= maxDist then
                local speed = part.AssemblyLinearVelocity.Magnitude
                local score = dist - speed * 0.2 -- ‡∏•‡∏π‡∏Å‡πÄ‡∏£‡πá‡∏ß = ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤
                if score < bestScore then
                    bestScore = score
                    best = part
                end
            end
        end
    end

    return best
end

-- LOOP ‡∏£‡∏∞‡∏î‡∏±‡∏ö AI
_G.ParryConnection = RunService.Heartbeat:Connect(function()
    local char = lp.Character
    if not char then return end

    local hrp = char:FindFirstChild("HumanoidRootPart")
    local highlight = char:FindFirstChild("Highlight")
    if not hrp or not highlight or not highlight.Enabled then return end

    local ball = getThreatBall(hrp)
    if ball then
        parry()
    end
end)
