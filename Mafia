--==================================================
-- FLUENT UI
--==================================================
local Fluent = loadstring(game:HttpGet(
    "https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"
))()

local Window = Fluent:CreateWindow({
    Title = "Auto WeaponCrate",
    SubTitle = "CargoShip",
    TabWidth = 160,
    Size = UDim2.fromOffset(520, 420),
    Acrylic = false,
    Theme = "Dark"
})

local Tab = Window:AddTab({ Title = "Main", Icon = "box" })

--==================================================
-- SERVICES
--==================================================
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local PlaceId = game.PlaceId -- à¹ƒà¸Šà¹‰ PlaceId à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¹€à¸à¸¡
local UIS = game:GetService("UserInputService")
local Camera = Workspace.CurrentCamera

local ESPEnabled = false
local AimPlayerEnabled = false
local AimNPCEnabled = false

--==================================================
-- CONFIG
--==================================================
local SPEED_FLY_1 = 35
local SPEED_FLY_2 = 100000

local TARGET_1 = CFrame.new(-385.564789, 20, -807.528015)
local TARGET_2 = CFrame.new(-57.7530785, 28, -405.38974)
local TARGET_3 = CFrame.new(-282.676361, 29.668602, -651.730347)

local LOOT_PATH =
    workspace
    :WaitForChild("Map")
    :WaitForChild("MapModel")
    :WaitForChild("CargoShip")
    :WaitForChild("Loot")

--==================================================
-- PROXIMITY PROMPT INSTANT
--==================================================
local function setPrompt(obj)
    if obj:IsA("ProximityPrompt") then
        obj.HoldDuration = 0
    end
end

for _, v in ipairs(workspace:GetDescendants()) do
    setPrompt(v)
end
workspace.DescendantAdded:Connect(setPrompt)

--==================================================
-- REMOVE NOCLIP DETECTOR
--==================================================
local function removeNoclipDetector(character)
    local detector = character:FindFirstChild("NoclipDetector")
    if detector then detector:Destroy() end

    character.ChildAdded:Connect(function(child)
        if child.Name == "NoclipDetector" then
            child:Destroy()
        end
    end)
end

local gui = Instance.new("ScreenGui")
gui.Name = "WeaponCrateCounter"
gui.ResetOnSpawn = false
gui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Parent = gui
frame.Size = UDim2.new(0, 240, 0, 45)
frame.Position = UDim2.new(0, 15, 1, -60)
frame.AnchorPoint = Vector2.new(0, 1)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.BackgroundTransparency = 0.15
frame.BorderSizePixel = 0

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = frame

local text = Instance.new("TextLabel")
text.Parent = frame
text.Size = UDim2.new(1, -12, 1, -12)
text.Position = UDim2.new(0, 6, 0, 6)
text.BackgroundTransparency = 1
text.Font = Enum.Font.GothamBold
text.TextScaled = true
text.TextColor3 = Color3.fromRGB(255,200,60)
text.Text = "WeaponCrate : 0"

--// HIGHLIGHT FUNCTION
local function applyHighlight(crate)
    if crate:FindFirstChild("CrateHighlight") then return end

    local h = Instance.new("Highlight")
    h.Name = "CrateHighlight"
    h.FillColor = Color3.fromRGB(255, 0, 0)
    h.FillTransparency = 0.5
    h.OutlineColor = Color3.fromRGB(255, 80, 80)
    h.OutlineTransparency = 0
    h.Adornee = crate
    h.Parent = crate
end

local function removeHighlight(crate)
    local h = crate:FindFirstChild("CrateHighlight")
    if h then
        h:Destroy()
    end
end

--// UPDATE FUNCTION
local function updateAll()
    local count = 0

    for _, v in ipairs(LOOT_PATH:GetChildren()) do
        if v.Name == "WeaponCrate" then
            count += 1
            applyHighlight(v)
        end
    end

    text.Text = "WeaponCrate : " .. count

    -- à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸«à¸¥à¸·à¸­à¸à¸¥à¹ˆà¸­à¸‡ à¸¥à¹‰à¸²à¸‡ Highlight à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    if count == 0 then
        for _, v in ipairs(LOOT_PATH:GetChildren()) do
            if v.Name == "WeaponCrate" then
                removeHighlight(v)
            end
        end
    end
end

--==================================================
-- PLAYER ESP
--==================================================
local highlightFolder = Workspace:FindFirstChild("HighlightContainer") or Instance.new("Folder")
highlightFolder.Name = "HighlightContainer"
highlightFolder.Parent = Workspace

local function getTeamColor(player)
    if not player.Team or not localPlayer.Team then
        return Color3.fromRGB(255,0,0)
    end
    return (player.Team == localPlayer.Team)
        and Color3.fromRGB(0,170,255)
        or Color3.fromRGB(255,0,0)
end

local function applyESP(p)
    if not ESPEnabled then return end
    if p == player then return end -- âŒ à¹„à¸¡à¹ˆà¸—à¸³ ESP à¹ƒà¸«à¹‰à¸•à¸±à¸§à¹€à¸­à¸‡

    local function setup(character)
        if not ESPEnabled then return end
        if p == player then return end -- à¸à¸±à¸™à¸‹à¹‰à¸³à¸­à¸µà¸à¸Šà¸±à¹‰à¸™

        local old = highlightFolder:FindFirstChild(p.Name .. "_ESP")
        if old then old:Destroy() end

        local h = Instance.new("Highlight")
        h.Name = p.Name .. "_ESP"
        h.Adornee = character
        h.FillColor = getTeamColor(p)
        h.OutlineColor = Color3.new(1,1,1)
        h.OutlineTransparency = 0.2
        h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        h.Parent = highlightFolder
    end

    p.CharacterAdded:Connect(setup)
    if p.Character then
        setup(p.Character)
    end
end

local function ClearESP()
    for _,v in ipairs(highlightFolder:GetChildren()) do
        v:Destroy()
    end
end

--==================================================
-- AIMLOCK PLAYER (E)
--==================================================

local PlayerLocking = false
local PlayerSettings = {
    Key = Enum.KeyCode.E,
    FOV = 60,
    Smooth = 0.4,
    AimPart = "Head"
}

local PlayerFOV = Drawing.new("Circle")
PlayerFOV.Visible = false
PlayerFOV.Thickness = 2
PlayerFOV.Radius = PlayerSettings.FOV
PlayerFOV.Color = Color3.new(1,1,1)
PlayerFOV.Filled = false

local function GetClosestPlayer()
    local closest, dist = nil, PlayerSettings.FOV
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local part = p.Character:FindFirstChild(PlayerSettings.AimPart)
            local hum = p.Character:FindFirstChild("Humanoid")
            if part and hum and hum.Health > 0 then
                local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local d = (center - Vector2.new(pos.X,pos.Y)).Magnitude
                    if d < dist then
                        closest = part
                        dist = d
                    end
                end
            end
        end
    end
    return closest
end

--==================================================
-- AIMLOCK NPC / ENEMY (F)
--==================================================
local NPCLocking = false
local NPCSettings = {
    Key = Enum.KeyCode.F,
    FOV = 60,
    Smooth = 0.4,
    AimPart = "Head"
}

local TargetFolders = {
    Workspace:WaitForChild("Enemies"),
    Workspace.Map.MapModel.JewelryStore:WaitForChild("Npcs"),
    Workspace.Map.MapModel.CargoShip:WaitForChild("Npcs"),
    Workspace.Map:WaitForChild("Civilians")
}

local NPCFOV = Drawing.new("Circle")
NPCFOV.Visible = false
NPCFOV.Radius = NPCSettings.FOV
NPCFOV.Thickness = 2
NPCFOV.Color = Color3.new(1,1,1)

local function GetClosestNPC()
    local closest, dist = nil, NPCSettings.FOV
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    for _,folder in ipairs(TargetFolders) do
        for _,m in ipairs(folder:GetChildren()) do
            if m:IsA("Model") then
                local hum = m:FindFirstChildOfClass("Humanoid")
                local part = m:FindFirstChild(NPCSettings.AimPart)
                if hum and part and hum.Health > 0 then
                    local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                    if onScreen then
                        local d = (center - Vector2.new(pos.X,pos.Y)).Magnitude
                        if d < dist then
                            closest = part
                            dist = d
                        end
                    end
                end
            end
        end
    end
    return closest
end

UIS.InputBegan:Connect(function(input,gp)
    if gp then return end

    if AimPlayerEnabled and input.KeyCode == PlayerSettings.Key then
        PlayerLocking = true
    end

    if AimNPCEnabled and input.KeyCode == NPCSettings.Key then
        NPCLocking = true
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.KeyCode == PlayerSettings.Key then
        PlayerLocking = false
    end
    if input.KeyCode == NPCSettings.Key then
        NPCLocking = false
    end
end)

RunService.RenderStepped:Connect(function()
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    PlayerFOV.Visible = AimPlayerEnabled
    NPCFOV.Visible = AimNPCEnabled
    PlayerFOV.Position = center
    NPCFOV.Position = center

    if AimPlayerEnabled and PlayerLocking then
        local t = GetClosestPlayer()
        if t then
            Camera.CFrame = Camera.CFrame:Lerp(
                CFrame.lookAt(Camera.CFrame.Position, t.Position),
                PlayerSettings.Smooth
            )
        end
    end

    if AimNPCEnabled and NPCLocking then
        local t = GetClosestNPC()
        if t then
            Camera.CFrame = Camera.CFrame:Lerp(
                CFrame.lookAt(Camera.CFrame.Position, t.Position),
                NPCSettings.Smooth
            )
        end
    end
end)


--==================================================
-- ADVANCED NOCLIP + STATE
--==================================================
local noclip = false
local flying = false
local noclipConn
local originalState = {}

local function SaveState(character)
    originalState = {}
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            originalState[part] = {
                CanCollide = part.CanCollide,
                CanTouch   = part.CanTouch,
                CanQuery   = part.CanQuery
            }
        end
    end
end

local function RestoreState()
    for part, state in pairs(originalState) do
        if part and part.Parent then
            part.CanCollide = state.CanCollide
            part.CanTouch   = state.CanTouch
            part.CanQuery   = state.CanQuery
        end
    end
    originalState = {}
end

local function EnableNoClip(character)
    if noclipConn then noclipConn:Disconnect() end
    noclipConn = RunService.Heartbeat:Connect(function()
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
                part.CanTouch   = false
                part.CanQuery   = false
            end
        end
    end)
end

local function DisableNoClip()
    if noclipConn then
        noclipConn:Disconnect()
        noclipConn = nil
    end
end

--==================================================
-- SMOOTH FLY (à¹€à¸”à¸´à¸¡ à¹„à¸¡à¹ˆà¹à¸à¹‰)
--==================================================
local function SmoothFly(targetCFrame, speed)
    if flying then return end
    flying = true

    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")

    SaveState(char)
    EnableNoClip(char)

    local velConn
    velConn = RunService.Heartbeat:Connect(function()
        if hrp and hrp.Parent then
            hrp.Velocity = Vector3.zero
            hrp.AssemblyLinearVelocity = Vector3.zero
        end
    end)

    local startPos = hrp.Position
    local targetY = targetCFrame.Position.Y
    local tY = math.abs(startPos.Y - targetY) / speed

    local tweenY = TweenService:Create(
        hrp,
        TweenInfo.new(tY, Enum.EasingStyle.Linear),
        { CFrame = CFrame.new(startPos.X, targetY, startPos.Z) * hrp.CFrame.Rotation }
    )
    tweenY:Play()
    tweenY.Completed:Wait()

    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    local tMove = dist / speed

    local tweenMove = TweenService:Create(
        hrp,
        TweenInfo.new(tMove, Enum.EasingStyle.Linear),
        { CFrame = targetCFrame }
    )
    tweenMove:Play()
    tweenMove.Completed:Wait()

    if velConn then velConn:Disconnect() end
    DisableNoClip()
    RestoreState()
    flying = false
end

--==================================================
-- LOCK VELOCITY (AUTOCRATE ONLY)
--==================================================
local lockVelConn

local function EnableLockVelocity(hrp)
    if lockVelConn then lockVelConn:Disconnect() end
    lockVelConn = RunService.Heartbeat:Connect(function()
        if hrp and hrp.Parent then
            hrp.Velocity = Vector3.zero
            hrp.AssemblyLinearVelocity = Vector3.zero
        end
    end)
end

local function DisableLockVelocity()
    if lockVelConn then
        lockVelConn:Disconnect()
        lockVelConn = nil
    end
end
--==================================================
-- AUTO WEAPON CRATE (SPAM FLY)
--==================================================

local autoCrate = false

task.spawn(function()
	while true do
		if autoCrate then
			local char = player.Character
			if not char then break end
			local hrp = char:FindFirstChild("HumanoidRootPart")
			if hrp then
				EnableLockVelocity(hrp)
				EnableNoClip(char) -- âœ… noclip à¸—à¸±à¹‰à¸‡à¸•à¸±à¸§
			end

			for _, crate in ipairs(LOOT_PATH:GetChildren()) do
				if not autoCrate then break end
				if crate.Name ~= "WeaponCrate" then continue end

				local part = crate:FindFirstChildWhichIsA("BasePart")
				local prompt = crate:FindFirstChildWhichIsA("ProximityPrompt", true)

				if part and prompt and crate.Parent then
					repeat
						if not autoCrate then break end

						hrp.CFrame = part.CFrame * CFrame.new(0, -2, 0)
                        task.wait(0.05)
						pcall(function()
							fireproximityprompt(prompt)
						end)

					until not crate.Parent

					if not crate.Parent then
						task.wait(3.5)
					end
				end
			end

			DisableLockVelocity()
			DisableNoClip()      -- âœ… à¸›à¸´à¸” noclip à¸«à¸¥à¸±à¸‡à¹€à¸à¹‡à¸šà¸«à¸¡à¸”
			RestoreState()       -- âœ… à¸„à¸·à¸™à¸„à¹ˆà¸² CanCollide / CanTouch / CanQuery
		end

		task.wait()
	end
end)


--==================================================
-- UI
--==================================================

Tab:AddToggle("autocrate", {
    Title = "Auto Warp Collect WeaponCrate",
    Default = false,
    Callback = function(v)
        autoCrate = v
        if not v then
            DisableLockVelocity()
        end
    end
})

Tab:AddButton({
    Title = "Fly To Sell",
    Callback = function()
        task.spawn(function()
            local char = player.Character or player.CharacterAdded:Wait()
            local hrp = char:WaitForChild("HumanoidRootPart")

            -- à¸ˆà¸¸à¸”à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
            local currentPos = hrp.Position

            -- 1) à¸¥à¸‡à¹„à¸›à¸—à¸µà¹ˆ Y = 20 (à¸„à¸‡ X,Z à¹€à¸”à¸´à¸¡)
            local downCFrame = CFrame.new(
                currentPos.X,
                20,
                currentPos.Z
            )

            -- 2) à¹„à¸› X,Z à¸‚à¸­à¸‡ TARGET_2 (à¸¢à¸±à¸‡ Y = 20)
            local moveXZCFrame = CFrame.new(
                TARGET_2.Position.X,
                20,
                TARGET_2.Position.Z
            )

            -- 3) à¸‚à¸¶à¹‰à¸™à¹„à¸› TARGET_2 à¸ˆà¸£à¸´à¸‡
            local finalCFrame = TARGET_2

            -- à¸—à¸³à¸‡à¸²à¸™à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸š
            SmoothFly(downCFrame, 35)
            SmoothFly(moveXZCFrame, 35)
            SmoothFly(finalCFrame, 35)
        end)
    end
})

Tab:AddButton({
    Title = "Fly To Jeweler",
    Callback = function()
        task.spawn(function()
            local char = player.Character or player.CharacterAdded:Wait()
            local hrp = char:WaitForChild("HumanoidRootPart")

            -- à¸ˆà¸¸à¸”à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
            local currentPos = hrp.Position

            -- 1) à¸¥à¸‡à¹„à¸›à¸—à¸µà¹ˆ Y = 20 (à¸„à¸‡ X,Z à¹€à¸”à¸´à¸¡)
            local downCFrame = CFrame.new(
                currentPos.X,
                20,
                currentPos.Z
            )

            -- 2) à¹„à¸› X,Z à¸‚à¸­à¸‡ TARGET_3 (à¸¢à¸±à¸‡ Y = 20)
            local moveXZCFrame = CFrame.new(
                TARGET_3.Position.X,
                20,
                TARGET_3.Position.Z
            )

            -- 3) à¸‚à¸¶à¹‰à¸™à¹„à¸› TARGET_3 à¸ˆà¸£à¸´à¸‡
            local finalCFrame = TARGET_3

            -- à¸—à¸³à¸‡à¸²à¸™à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸š
            SmoothFly(downCFrame, 35)
            SmoothFly(moveXZCFrame, 35)
            SmoothFly(finalCFrame, 35)
        end)
    end
})

Tab:AddButton({
    Title = "Fly To Harbor",
    Callback = function()
        task.spawn(function()
            SmoothFly(TARGET_1, SPEED_FLY_1)
        end)
    end
})

Tab:AddButton({
    Title = "Sell",
    Callback = function()
        SmoothFly(TARGET_2, SPEED_FLY_2)
    end
})

Tab:AddButton({
    Title = "Teleport Random Server",
    Callback = function()
        task.spawn(function()
            local success, servers = pcall(function()
                local url = "https://games.roblox.com/v1/games/"..PlaceId.."/servers/Public?sortOrder=Asc&limit=100"
                local response = game:HttpGet(url)
                return HttpService:JSONDecode(response)
            end)

            if success and servers and servers.data then
                local chosen
                local players = game.Players.LocalPlayer
                -- à¸«à¸² server à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹€à¸•à¹‡à¸¡
                for _, s in ipairs(servers.data) do
                    if s.playing < s.maxPlayers and s.id ~= game.JobId then
                        chosen = s.id
                        break
                    end
                end

                if chosen then
                    TeleportService:TeleportToPlaceInstance(PlaceId, chosen, game.Players.LocalPlayer)
                else
                    warn("No available servers found!")
                end
            else
                warn("Failed to get server list")
            end
        end)
    end
})

local TabP = Window:AddTab({ Title = "Player", Icon = "crosshair" })

TabP:AddToggle("Noclip", {
    Title = "Noclip",
    Default = false,
    Callback = function(v)
        noclip = v
        local char = player.Character
        if not char then return end

        if v then
            SaveState(char)
            EnableNoClip(char)
        else
            DisableNoClip()
            RestoreState()
        end
    end
})

TabP:AddToggle("ESP", {
    Title = "Player ESP",
    Default = false,
    Callback = function(v)
        ESPEnabled = v

        ClearESP() -- ðŸ”¥ à¸¥à¹‰à¸²à¸‡à¸à¹ˆà¸­à¸™à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡

        if v then
            for _,p in ipairs(Players:GetPlayers()) do
                if p ~= player then
                    applyESP(p)
                end
            end
        end
    end
})

TabP:AddToggle("AimPlayer", {
    Title = "Aimlock Player(E)",
    Default = false,
    Callback = function(v)
        AimPlayerEnabled = v
        PlayerLocking = false
    end
})

TabP:AddToggle("AimNPC", {
    Title = "Aimlock NPC(F)",
    Default = false,
    Callback = function(v)
        AimNPCEnabled = v
        NPCLocking = false
    end
})

--==================================================
-- CHARACTER SPAWN
--==================================================
player.CharacterAdded:Connect(function(char)
    noclip = false
    flying = false
    DisableNoClip()
    DisableLockVelocity()
    originalState = {}
    removeNoclipDetector(char)
end)

if player.Character then
    removeNoclipDetector(player.Character)
end

updateAll()
LOOT_PATH.ChildAdded:Connect(updateAll)
LOOT_PATH.ChildRemoved:Connect(updateAll)
