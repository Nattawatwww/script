--================================
-- AUTO WEAPON CRATE NO UI + STATUS
--================================

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local PlaceId = game.PlaceId
local teleporting = false
local MAX_TP_RETRY = 10

-- WAIT FOR GAME / PLAYER / CHAR / HRP / LOOT
if not game:IsLoaded() then game.Loaded:Wait() end
repeat task.wait() until player

local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")

local LOOT_PATH
repeat
    LOOT_PATH = workspace:FindFirstChild("Map")
                and workspace.Map:FindFirstChild("MapModel")
                and workspace.Map.MapModel:FindFirstChild("CargoShip")
                and workspace.Map.MapModel.CargoShip:FindFirstChild("Loot")
    task.wait(0.5)
until LOOT_PATH

-- STATUS UI
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.ResetOnSpawn = false
local status = Instance.new("TextLabel", gui)
status.Size = UDim2.new(0, 650, 0, 40)
status.Position = UDim2.new(0.5, -325, 0, 10)
status.BackgroundColor3 = Color3.fromRGB(20,20,20)
status.BackgroundTransparency = 0.25
status.TextColor3 = Color3.new(1,1,1)
status.Font = Enum.Font.GothamBold
status.TextScaled = true
status.BorderSizePixel = 0
status.TextStrokeTransparency = 0.4
status.ZIndex = 9999
status.Text = "ðŸ”„ Initializing..."
local function setStatus(txt) status.Text = txt end

-- POSITION TO SELL
local SELL_CF = CFrame.new(-57.7530785, 29, -405.38974)

-- STATE
local autoCrate = true
local noclipConn, velConn
local savedState = {}
local waitingTeleport = false

--==============================
-- UTIL FUNCTIONS
--==============================
local function GetCrateCount()
    local count = 0
    for _,v in ipairs(LOOT_PATH:GetChildren()) do
        if v.Name == "WeaponCrate" then count += 1 end
    end
    return count
end

local function SaveState(char)
    savedState = {}
    for _,v in ipairs(char:GetDescendants()) do
        if v:IsA("BasePart") then
            savedState[v] = { v.CanCollide, v.CanTouch, v.CanQuery }
        end
    end
end

local function RestoreState()
    for p,s in pairs(savedState) do
        if p and p.Parent then
            p.CanCollide = s[1]
            p.CanTouch   = s[2]
            p.CanQuery   = s[3]
        end
    end
    savedState = {}
end

local function EnableNoClip(char)
    if noclipConn then noclipConn:Disconnect() end
    noclipConn = RunService.Heartbeat:Connect(function()
        for _,v in ipairs(char:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = false
                v.CanTouch   = false
                v.CanQuery   = false
            end
        end
    end)
end

local function DisableNoClip()
    if noclipConn then noclipConn:Disconnect() end
end

local function LockVel(hrp)
    if velConn then velConn:Disconnect() end
    velConn = RunService.Heartbeat:Connect(function()
        hrp.Velocity = Vector3.zero
        hrp.AssemblyLinearVelocity = Vector3.zero
    end)
end

local function UnlockVel()
    if velConn then velConn:Disconnect() end
end

--==============================
-- SERVER HOP
--==============================
local function findRandomServer()
	local url = "https://games.roblox.com/v1/games/"..PlaceId.."/servers/Public?sortOrder=Asc&limit=100"

	local success, result = pcall(function()
		return game:HttpGet(url)
	end)

	if success then
		local data = HttpService:JSONDecode(result)
		local servers = {}

		for _, server in ipairs(data.data) do
			if server.id ~= currentJobId then
				table.insert(servers, server.id)
			end
		end

		if #servers > 0 then
			return servers[math.random(1, #servers)]
		end
	end
	return nil
end

local function TeleportRS()
	if teleporting then return end
	teleporting = true

	local currentJobId = game.JobId
	local tries = 0

	while tries < MAX_TP_RETRY do
		tries += 1
		setStatus("ðŸŒ à¸à¸³à¸¥à¸±à¸‡à¸¢à¹‰à¸²à¸¢à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ... ("..tries..")")

		local jobId = findRandomServer()
		if jobId then
			pcall(function()
				TeleportService:TeleportToPlaceInstance(PlaceId, jobId, player)
			end)
		end

		task.wait(4)

		if game.JobId ~= currentJobId then
			return
		end
	end

	teleporting = false
	warn("âŒ à¸§à¸²à¸›à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸žà¸¢à¸²à¸¢à¸²à¸¡ "..MAX_TP_RETRY.." à¸„à¸£à¸±à¹‰à¸‡")
	setStatus("âŒ à¸§à¸²à¸›à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ | à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡")
end


--==============================
-- AUTO CRATE LOOP
--==============================
local function AutoCrateLoop()
    SaveState(char)
    EnableNoClip(char)
    LockVel(hrp)

    while autoCrate do
        local crateCount = GetCrateCount()
        local weaponCrateInChar = char:FindFirstChild("PlayerWeaponCrate")

        if crateCount == 0 and not weaponCrateInChar then
            setStatus("âŒ à¹„à¸¡à¹ˆà¸¡à¸µ WeaponCrate | à¸à¸¥à¹ˆà¸­à¸‡à¹€à¸«à¸¥à¸·à¸­ 0 | à¸à¸³à¸¥à¸±à¸‡à¸¢à¹‰à¸²à¸¢à¹€à¸‹à¸´à¸£à¹Œà¸Ÿ")
            TeleportRS()
            return
        end

        if crateCount == 0 and weaponCrateInChar and not waitingTeleport then
            waitingTeleport = true
            task.spawn(function()
                while autoCrate and char:FindFirstChild("PlayerWeaponCrate") do task.wait(0.2) end
                task.wait(3)
                if autoCrate and GetCrateCount() == 0 then TeleportRS() end
                waitingTeleport = false
            end)
        end

        for _, crate in ipairs(LOOT_PATH:GetChildren()) do
            if crate.Name ~= "WeaponCrate" then continue end
            local part = crate:FindFirstChildWhichIsA("BasePart")
            local prompt = crate:FindFirstChildWhichIsA("ProximityPrompt", true)
            if part and prompt and crate.Parent then
                while autoCrate and crate.Parent do
                    setStatus("ðŸ“¦ à¸Ÿà¸²à¸£à¹Œà¸¡à¸­à¸¢à¸¹à¹ˆ | à¸à¸¥à¹ˆà¸­à¸‡à¹€à¸«à¸¥à¸·à¸­ "..GetCrateCount())
                    hrp.CFrame = part.CFrame * CFrame.new(0,-5,0)
                    task.wait(0.09)
                    pcall(function() fireproximityprompt(prompt) end)
                    task.wait(0.03)

                    if char:FindFirstChild("PlayerWeaponCrate") then
                        setStatus("ðŸ’° à¹„à¸”à¹‰à¸‚à¸­à¸‡à¹à¸¥à¹‰à¸§ | à¸à¸³à¸¥à¸±à¸‡à¹„à¸›à¸‚à¸²à¸¢ | à¸à¸¥à¹ˆà¸­à¸‡à¹€à¸«à¸¥à¸·à¸­ "..GetCrateCount())
                        repeat
                            hrp.CFrame = SELL_CF
                            task.wait(0.5)
                        until not char:FindFirstChild("PlayerWeaponCrate")
                        break
                    end
                end
            end
        end
    end

    UnlockVel()
    DisableNoClip()
    RestoreState()
end

--==============================
-- DEATH HANDLE
--==============================
local function BindDeath(char)
    local hum = char:WaitForChild("Humanoid")
    local died = false
    hum.HealthChanged:Connect(function(hp)
        if died then return end
        if hp <= 0 and autoCrate then
            died = true
            autoCrate = false
            waitingTeleport = false
            UnlockVel()
            DisableNoClip()
            RestoreState()
            setStatus("â˜ ï¸ à¸„à¸¸à¸“à¸•à¸²à¸¢à¹à¸¥à¹‰à¸§ | à¸à¸³à¸¥à¸±à¸‡à¸¢à¹‰à¸²à¸¢à¹€à¸‹à¸´à¸£à¹Œà¸Ÿ")
            TeleportRS()
        end
    end)
end

BindDeath(char)
task.spawn(AutoCrateLoop)
